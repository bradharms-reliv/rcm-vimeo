<?php
$ratio = $this->instanceConfig['aspectRatio'];
$videoId = $this->instanceConfig['videoId'];
$videoUrl = "https://player.vimeo.com/video/{$videoId}";
$downloadLinkType = $this->instanceConfig['downloadLinkType'];
$downloadWidth = (int)$this->instanceConfig['downloadWidth'];
$downloadLink = '';

switch ($downloadLinkType) {
    case 'custom' :
        $downloadLink = $this->instanceConfig['downloadLink'];
        break;
    case 'vimeo-api':
        $downloadLink = '/vimeo/video/{videoId}/download';

        if (!empty($downloadWidth)) {
            $downloadLink = "{$downloadLink}?width={$downloadWidth}";
        }
        break;
    default:
        $downloadLink = '';
        break;
}

$downloadLink = str_replace('{videoId}', $videoId, $downloadLink);

$query = [];

if (!empty($this->instanceConfig['autoPlay'])) {
    $query[$this->instanceConfig['autoPlay']] = '1';
}
if (!empty($query)) {
    $videoUrl = $videoUrl . '?' . http_build_query($query);
}

$downloadLinkStyle = (empty($downloadLink) ? 'display: none;' : '');

?>
<div class="rcm-vimeo">
    <div class="rcm-vimeo-video">
        <a id="rcm-vimeo-a-tag-<?= $this->instanceId; ?>" class="rcm-vimeo-video-download" style="<?= $downloadLinkStyle ?>" target="_blank">Download Video</a>
        <script>
            document.getElementById('rcm-vimeo-a-tag-<?= $this->instanceId; ?>').href='<?= $downloadLink ?>';
        </script>
        <div class='embed-container' rcm-vimeo-aspect-ratio="<?= $ratio; ?>">
            <iframe rcm-vimeo-aspect-ratio="<?= $ratio; ?>"
                    src='<?= $videoUrl; ?>'
                    frameborder='0'
                    webkitAllowFullScreen
                    mozallowfullscreen
                    allowFullScreen></iframe>
        </div>
        <div class='embed-container placeholder' rcm-vimeo-aspect-ratio="<?= $ratio; ?>">
            <div class="icon">&nbsp;</div>
            <div class="label">
                <a href="https://vimeo.com/<?= $videoId ?>" target="_blank">
                    https://vimeo.com/<?= $videoId ?>
                </a>
            </div>
        </div>
    </div>
</div>
